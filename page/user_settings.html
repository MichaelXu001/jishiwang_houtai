<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>用户设置</title>
    <link rel="stylesheet" href="./../css/common.css">
    <link rel="stylesheet" href="./../css/style.css">
</head>

<body>
    <div class="nav">
        <div class="leftgroup">
            <div class="logo" id="logo">
                <a href="/"></a>
            </div>
            <div class="telescopic shrink" id="telescopic"><img src="./../images/zd.png" alt=""></div>
        </div>
        <div class="rightgroup">
            <ul>
                <li class="name" id="topname"><a href="">旭阳科技</a></li>
                <li class="intentionOrder"><a href="">意向单</a></li>
                <li class="legalService"><a href="">法律服务</a></li>
                <li class="quit" id="quit"><a href="javascript:void(0);">退出</a></li>
            </ul>
            <div class="namePic"><img alt=""></div>
        </div>
    </div>
    <div class="main">
        <div class="container">
            <div class="rightMain" id="rightMain">
                <div class="projectType" id="changeSetting" style="height:65px;">
                    <ul>
                        <li>企业资料</li>
                        <li class="active">安全设置</li>
                    </ul>
                </div>
                <div class="settingMain" id="settingMain">
                    <div class="securityBox">
                        <div class="reviseinfor revisePwd">
                            <p>修改密码</p>
                            <div class="revisePwdBtn">修改密码</div>
                            <div class="inputBox none">
                                <iframe name="ajaxFrame1" id="ajaxFrame1" style="display: none;"></iframe>
                                <form target="ajaxFrame1" action="http://39.108.191.122/Portal/User/chanpass">
                                    <ul>
                                        <li><input type="password" class="pass" id="pass" placeholder="请输入旧密码" required="required"></li>
                                        <li><input type="password" class="password" id="password" placeholder="请输入新密码" required="required"></li>
                                        <li>
                                            <input type="password" class="password2" id="password1" placeholder="再次输入新密码" required="required">
                                            <!-- <div class="change">修改</div> -->
                                            <input type="submit" value="修改" id="chanpassBtn" class="inputBtn">
                                            <div class="cancel">取消</div>
                                        </li>
                                    </ul>
                                </form>
                            </div>
                            <div class="clear"></div>
                        </div>
                        <div class="reviseinfor reviseTel">
                            <p>手机绑定</p>
                            <div class="oldNum" id="oldNum"></div>
                            <div class="revisePwdBtn">更改绑定</div>
                            <div class="inputBox none">
                                <iframe name="ajaxTelFrame2" id="ajaxTelFrame2" style="display: none;"></iframe>
                                <form target="ajaxTelFrame2" action="http://39.108.191.122/Portal/User/checksmscodes" id="ajaxFrame2From">
                                    <ul>
                                        <li>
                                            <input type="text" class="pass" placeholder="请输入旧手机号" id="oldtel" disabled="disabled" required="required" pattern="^1[345678][0-9]{9}$" maxlength="11">
                                            <input type="button" class="codeBtn" id="codeTelBtn" value="获取验证码">
                                            <input type="hidden" id="smsid">
                                        </li>
                                        <li>
                                            <input type="text" class="password" placeholder="请输入新手机号" id="newtel" required="required" pattern="^1[345678][0-9]{9}$" maxlength="11">

                                        </li>
                                        <li>
                                            <input type="text" class="password2" placeholder="输入验证码" id="smscode" required="required">
                                            <input type="submit" class="change" id="changetelBtn" value="修改">
                                            <div class="cancel">取消</div>
                                        </li>
                                    </ul>
                                </form>

                            </div>
                            <div class="clear"></div>
                        </div>
                        <div class="reviseinfor reviseEmail">
                            <p>邮箱绑定</p>
                            <div class="oldNum" id="oldEmail"></div>
                            <div class="revisePwdBtn">更改绑定</div>
                            <div class="inputBox none">
                                <iframe name="ajaxEmial" id="ajaxEmial" style="display: none;"></iframe>
                                <form target="ajaxEmial" action="http://39.108.191.122/Portal/User/send" id="ajaxEmialFrom">
                                    <ul>
                                        <!-- <li><input type="password" class="pass" placeholder="请输入邮箱"></li> -->
                                        <li>
                                            <input type="email" class="password" id="emailVal" placeholder="请输入邮箱" required="required">
                                            <input type="submit" class="codeBtn" id="codeEmailBtn" value="绑定邮箱">

                                        </li>
                                        <li>
                                            <p class="goEmail none" id="goEmail">邮件已发送，请去邮箱进行激活</p>
                                            <!-- <input type="text" class="password2" id="emailCode" placeholder="请输入验证码" required="required">
                                        <input type="submit" class="change" id="changeEmailBtn" value="修改">
                                        <div class="cancel">取消</div> -->
                                        </li>
                                    </ul>
                                </form>
                            </div>
                            <div class="clear"></div>
                        </div>
                        <div class="reviseinfor revisePic">
                            <p>实名认证</p>
                            <div class="qualifications" id="qualifications">
                                <!-- <div class="qualificationsImg">
                                <img src="./../images/qualificationsBigImg.jpg" alt="">
                                <div class="closeImg"></div>
                            </div> -->
                                <form id="uploadAuthentication" style="float:left" enctype="multipart/form-data">
                                    <div class="uploadImg"><input type="file" id="uploadImg" name="file" multiple="multiple"><label for="uploadImg"></label></div>
                                </form>

                            </div>
                            <div class="warning">*上传企业资质或身份证件（最多上传5张）</div>
                            <div class="clear"></div>
                        </div>
                    </div>
                    <div class="enterpriseInforBox none">
                        <div class="reviseinfor reviseUsername">
                            <p>更改名称</p>
                            <div class="userName" id="userName"></div>
                            <div class="revisePwdBtn">更改名称</div>
                            <div class="inputBox none">
                                <iframe name="ajaxFrame2" id="ajaxFrame2" style="display: none;"></iframe>
                                <form target="ajaxFrame2" action="http://39.108.191.122/Portal/User/askusers" id="ajaxFrame2From">
                                    <ul>
                                        <li>
                                            <input type="text" class="changeuserName" id="changeuserName" required="required" value="">
                                            <!-- <div class="change">修改</div> -->
                                            <input type="submit" value="修改" id="changeNameBtn" class="inputBtn">
                                            <div class="cancel">取消</div>
                                        </li>
                                    </ul>
                                </form>
                            </div>
                            <div class="clear"></div>
                        </div>
                        <div class="reviseinfor reviseLogo">
                            <p>更改logo</p>
                            <div class="qualifications" id="peoplequalifications">
                                <div class="qualificationsImg none" id="peoplequalificationsImg">
                                    <img src="./../images/123.png" alt="">
                                    <div class="closeImg"></div>
                                </div>
                                <form id="uploadForm" enctype="multipart/form-data" style="float: left;">
                                    <div class="uploadImg" id="peopleUploadImg"><input type="file" id="uploadImgLogo" name="file" multiple="multiple"><label for="uploadImgLogo"></label></div>
                                </form>
                            </div>
                            <div class="clear"></div>
                        </div>
                        <div class="reviseinfor addAdress" id="addAdress">
                            <div class="evaryAdress">
                                <p>地址管理</p>
                                <div class="detailedAdressBox fl" id="detailedAdressBox">

                                </div>
                            </div>
                            <div class="clear"></div>
                            <iframe name="addAdressgroup" id="" style="display: none;"></iframe>
                            <form target="addAdressgroup" action="http://39.108.191.122/Portal/User/addadress" id="">
                                <div class="addAdressgroup" id="addAdressgroup">
                                    <div class="selects">
                                        <select name="省" id="province" class="province" required="required">
                                </select>
                                    </div>
                                    <div class="selects">
                                        <select name="省" id="city" class="city" required="required">
                                    <option value="">请选择</option>
                                </select>
                                    </div>
                                    <div class="selects">
                                        <select name="省" id="county" class="county" required="required">
                                    <option value="">请选择</option>
                                </select>
                                    </div>
                                    <div class="inputBox">
                                        <ul style="margin-top: 10px;">
                                            <li>
                                                <input type="text" class="addInput" id="detailAdressInput" placeholder="请输入详细地址" required="required">
                                                <input type="text" class="addInput" id="detailTelInput" placeholder="请输入电话" required="required" maxlength="11" pattern="^1[345678][0-9]{9}$">
                                                <input type="text" class="addInput" id="detailNameInput" placeholder="请输入姓名" required="required">
                                                <input class="change" id="addAdressBtn" type="submit" value="新增">
                                                <div class="cancelAddress" id="cancelAddress">取消</div>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="clear"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="leftMenu" id="leftMenu">
            <ul>
                <li class="UserCenter">
                    <span><img src="./../images/center.png" alt=""></span>
                    <a href="./index.html">用户中心首页</a>
                </li>
                <li class="myIntentionOrder">
                    <span><img src="./../images/IntentionOrder.png" alt=""></span>
                    <a href="./my_intention_order.html?type=000&status=3">我的意向单</a>
                </li>
                <li class="myOrder">
                    <span><img src="./../images/order.png" alt=""></span>
                    <a href="./my_order.html?status=0">我的订单</a>
                </li>
                <li class="myShoppingCart">
                    <span><img src="./../images/ShoppingCart.png" alt=""></span>
                    <a href="./my_shopping_cart.html">我的购物车</a>
                </li>
                <li class="myCollection">
                    <span><img src="./../images/Collection.png" alt=""></span>
                    <a href="./my_collection.html?type=000">我的收藏</a>
                </li>
                <li class="customerService">
                    <span><img src="./../images/customer.png" alt=""></span>
                    <a href="">客户服务</a>
                </li>
                <li class="userSettings active">
                    <span><img src="./../images/setting.png" alt=""></span>
                    <a href="./user_settings.html">用户设置</a>
                </li>
            </ul>
        </div>

    </div>
    <div class="qualificationsBigImg none" id="qualificationsBigImg">
        <div class="closeBigImg" id="closeBigImg"><img src="./../images/icon_close.png" alt=""></div>
        <div class="BigImg" id="BigImg"><img src="./../images/qualificationsBigImg.jpg" alt=""></div>
    </div>


    <script src="./../js/jquery.min.js"></script>
    <script src="./../js/md5.js"></script>
    <script src="./../js/common.js"></script>
    <script>
        var funObj = {
            inits: function() {
                this.changeSettingtFun();
                this.reviseFun(); //修改密码
                this.changeAdress(); //增加地址的三级联动
                this.changeLogo(); //更改logo上传图片
                this.addAdressFun(); //新增地址



            },
            InterfaceObj: {
                chanpass: "http://39.108.191.122/Portal/User/chanpass", //修改密码
                askusers: "http://39.108.191.122/Portal/User/askusers", //修改用户名
                linkageone: "http://39.108.191.122/Portal/User/linkageone", //三级联动－省
                linkagetwo: "http://39.108.191.122/Portal/User/linkagetwo", //三级联动－市
                linkagethree: "http://39.108.191.122/Portal/User/linkagethree", //三级联动－省 
                ajaxuploadentlogo: "http://39.108.191.122/Portal/User/ajaxuploadentlogo", //修改头像
                addadress: "http://39.108.191.122/Portal/User/addadress", //增加地址
                askphone: "http://39.108.191.122/Portal/User/askphone", //发送手机验证码
                send: "http://39.108.191.122/Portal/User/send", //发送邮箱验证码 
                checksmscodes: "http://39.108.191.122/Portal/User/checksmscodes", //验证手机号验证码
                ajaxuploadents: "http://39.108.191.122/Portal/User/ajaxuploadents", //验证手机号验证码
                delpic: "http://39.108.191.122/Portal/User/delpic" //删除图片
            },
            changeSettingtFun: function() {
                $("#changeSetting").on("click", "li", function() {
                    $(this).addClass("active").siblings("li").removeClass("active")
                    var ind = $(this).index();
                    $("#settingMain").children("div").eq(ind).hide().siblings("div").show();
                })
            },
            addAdressFun: function() {
                $("#addAdressBtn").click(function() {
                    var addAdressObj = {
                        adress: $("#province").val() + " " + $("#city").val() + " " + $("#county").val() + " " + $("#detailAdressInput").val() + " , 电话:" + $("#detailTelInput").val() + " , 姓名:" + $("#detailNameInput").val()
                    };

                    if ($("#province").val() != "" && $("#city").val() != "" && $("#county").val() != "" && $("#detailAdressInput").val() != "") {
                        common.ajaxFun(funObj.InterfaceObj.addadress, "GET", addAdressObj, function(res) {
                            var str = "";
                            if (res.status == 1) {
                                str += '<div class="detailedAdress">' +
                                    '<div class="adress">' + $("#province").val() + '' + $("#city").val() + '' + $("#county").val() + '' + $("#detailAdressInput").val() + ' , 电话:' + $("#detailTelInput").val() + ' , 姓名:' + $("#detailNameInput").val() + '</div>' +
                                    '<div class="closeAdress" data_id=' + res.data.nums + '></div>' +
                                    '</div>';
                                $("#detailedAdressBox").prepend($(str))
                            } else if (res.status == -1) {
                                alert("增加接口失败了返回－1")
                            }
                        });
                    }
                });
                $("#cancelAddress").click(function() {
                    $("#province option:first").attr("selected", true);
                    $("#city").html('<option value="">请选择</option>');
                    $("#county").html('<option value="">请选择</option>');
                    $("#detailAdressInput,#detailTelInput,#detailNameInput").val("")
                })

            },
            changeLogo: function() {
                $("#uploadImgLogo").on("change", function(res) {
                    $.ajax({
                        url: funObj.InterfaceObj.ajaxuploadentlogo,
                        type: 'POST',
                        cache: false,
                        dataType: "json",
                        data: new FormData($('#uploadForm')[0]),
                        processData: false,
                        contentType: false,
                        success: function(res) {
                            if (res.status == 1) {
                                $(".namePic img,#peoplequalificationsImg img").attr({
                                    "src": res.data.url
                                });
                                $("#peopleUploadImg").hide();
                                $("#peoplequalificationsImg").show();
                            } else if (res.status == -1) {
                                alert("上传图片接口返回－1啦");
                            }
                        }
                    })
                });

                $("#uploadImg").on("change", function(res) {
                    $.ajax({
                        url: funObj.InterfaceObj.ajaxuploadents,
                        type: 'POST',
                        cache: false,
                        dataType: "json",
                        data: new FormData($('#uploadAuthentication')[0]),
                        processData: false,
                        contentType: false,
                        success: function(res) {
                            if (res.status == 1) {
                                var str = "";
                                str += '<div class="qualificationsImg">'
                                str += ' <img src="' + res.data.url + '" alt="">'
                                str += '<div class="closeImg" data_id=' + res.picid + '></div>'
                                str += ' </div>'
                                $("#qualifications").prepend($(str));
                                if ($("#qualifications .qualificationsImg").length >= 5) {
                                    $("#uploadAuthentication").hide();
                                }
                                $("#qualifications .qualificationsImg img").click(function() {
                                    var imgSrc = $(this).attr("src");
                                    $("#qualificationsBigImg").fadeIn(500);
                                    $("#BigImg img").attr("src", imgSrc);
                                });
                                $("#qualifications .closeImg").click(function() { //delpic走一个删除图片的接口
                                    var that = $(this),
                                        id = that.attr("data_id");
                                    common.ajaxFun(funObj.InterfaceObj.delpic, "GET", {
                                        id: id
                                    }, function(res) {
                                        if (res.status == 1) {
                                            that.parents(".qualificationsImg").remove();
                                            if ($("#qualifications .qualificationsImg").length < 5) {
                                                $("#uploadAuthentication").show();
                                            }
                                        } else if (res.status == -1) {
                                            alert("删除图片接口返回－1啦");
                                        }
                                    })

                                });
                            } else if (res.status == -1) {
                                alert("上传资质认证接口返回－1啦");
                            }
                        }
                    })
                });

                funObj.logoOperationFun(); //小图片的操作，删除，放大，关闭放大
            },
            logoOperationFun: function() {
                $("#peoplequalificationsImg .closeImg").click(function() { //走一个删除图片的接口
                    $("#peoplequalificationsImg").hide();
                    $("#peopleUploadImg").show();
                });
                $("#peoplequalificationsImg img").click(function() {
                    var imgSrc = $(this).attr("src");
                    $("#qualificationsBigImg").fadeIn(500);
                    $("#BigImg img").attr("src", imgSrc);
                });


                $("#closeBigImg").click(function() {
                    $("#qualificationsBigImg").fadeOut(500);
                })
            },
            changeAdress: function() {
                common.ajaxFun(funObj.InterfaceObj.linkageone, "GET", {}, function(res) {
                    var str = "<option value=>请选择</option>";
                    $.each(res, function(i, v) {
                        str += "<option data_provinceid=" + v.provinceid + " value=" + v.province + ">" + v.province + "</option>"
                    })
                    $("#province").html($(str));
                });
                $("#province").on("change", function() {
                    $("#province option:first").attr("selected", false);

                    var provinceID = $("#province").find("option:selected").attr("data_provinceid");
                    common.ajaxFun(funObj.InterfaceObj.linkagetwo, "GET", {
                        type: provinceID
                    }, function(res) {

                        var str = "";
                        if (res.status == -1) {
                            str = "<option value=>请选择</option>";
                            $("#county").html($(str));
                            $("#city").html($(str));
                        } else {
                            $.each(res, function(i, v) {
                                str += "<option data_cityid=" + v.cityid + " value=" + v.city + ">" + v.city + "</option>"
                            })
                            $("#city").html($(str));
                            common.ajaxFun(funObj.InterfaceObj.linkagethree, "GET", {
                                type: res[0].cityid
                            }, function(res) {
                                var str = "";
                                if (res.status == -1) {
                                    str = "<option value=>请选择</option>";
                                } else {
                                    $.each(res, function(i, v) {
                                        str += "<option data_areaid=" + v.areaid + " value=" + v.area + ">" + v.area + "</option>"
                                    })
                                }
                                $("#county").html($(str));
                            });
                        }
                    });
                });
                $("#city").on("change", function() {

                    var cityID = $("#city").find("option:selected").attr("data_cityid");
                    common.ajaxFun(funObj.InterfaceObj.linkagethree, "GET", {
                        type: cityID
                    }, function(res) {
                        var str = "";
                        $.each(res, function(i, v) {
                            str += "<option data_areaid=" + v.areaid + " value=" + v.area + ">" + v.area + "</optiondata_id>"
                        })
                        $("#county").html($(str));
                    });
                });

            },
            reviseFun: function() {
                $(".revisePwdBtn").on("click", function() {
                    $(this).hide();
                    $(this).prevAll("div").hide();
                    $(this).next("div.inputBox").show();
                    funObj.chanpassFun(); //修改密码
                    funObj.changeTelFun(); //修改电话 
                    funObj.changeNameFun(); //修改用户名
                    funObj.changeEmailFun() //绑定邮箱
                });
                $(".cancel").on("click", function() {
                    $(this).parents("div.inputBox").prevAll("div").show();
                    $(this).parents("div.inputBox").hide();
                });
            },
            changeNameFun: function() {
                $("#changeNameBtn").click(function() {
                    var changeuserName = $("#changeuserName").val(),
                        that = $(this);
                    if (changeuserName != "") {
                        common.ajaxFun(funObj.InterfaceObj.askusers, "GET", {
                            "username": changeuserName
                        }, function(res) {
                            if (res.status == 1) {
                                $("#userName,#topname a").html(changeuserName);
                                that.parents("div.inputBox").prevAll("div").show();
                                that.parents("div.inputBox").hide();
                            } else if (res.status == -2) {
                                alert("未知错误，返回－2");
                            } else if (res.status == -1) {
                                alert("名字已经有啦，返回－1");
                            }
                        })

                    }

                })
            },
            chanpassFun: function() {
                $("#chanpassBtn").click(function() {
                    var pass = $("#pass").val(),
                        password = $("#password").val(),
                        password1 = $("#password1").val(),
                        chanpassObj = {},
                        that = $(this);
                    if (password != password1) {
                        alert("两次输入的密码不一样！");
                        $("#password").val("")
                        $("#password1").val("")
                    } else {
                        if (pass != "" && password != "" && password != "") {
                            chanpassObj.pass = md5($("#pass").val());
                            chanpassObj.password = md5($("#password").val());
                            // chanpassObj.username = "hhh"; //暂时的 测试专用用户名
                            common.ajaxFun(funObj.InterfaceObj.chanpass, "GET", chanpassObj, function(res) {
                                // console.log(res);
                                if (res.status == 1) {
                                    alert("修改成功");
                                    that.parents("div.inputBox").prevAll("div").show();
                                    that.parents("div.inputBox").hide();
                                } else {
                                    alert("修改失败，返回－1");
                                }
                            })
                        }
                    }

                })
            },
            changeTelFun: function() {
                $("#codeTelBtn").on("click", function() { //获取短信验证吗askphone
                    var oldtelVal = $("#oldtel").val();

                    common.ajaxFun(funObj.InterfaceObj.askphone, "GET", {}, function(res) {
                        if (res.status == 1) {
                            $("#smsid").val(res.data);
                            $("#oldtel").attr("disabled");
                            funObj.setTimeoutFun(60, $("#codeTelBtn"));
                        } else {
                            alert("电话接口返回－1了");
                        }
                    })


                });
                $("#changetelBtn").click(function() {
                    var checksmscodesObj = {
                            smscode: $("#smscode").val(), //短信验证码
                            smsid: $("#smsid").val(), //后台反过来的验证码
                            cellphone: $("#newtel").val() //新手机号
                        },
                        that = $(this);
                    if ($("#oldtel").val() == "" || $("#newtel").val() == "" || $("#smscode").val() == "") {
                        alert("输入框不能为空！")
                    } else {
                        common.ajaxFun(funObj.InterfaceObj.checksmscodes, "GET", checksmscodesObj, function(res) {
                            if (res.status == 1) {
                                $("#oldNum").html(checksmscodesObj.cellphone);
                                that.parents("div.inputBox").prevAll("div").show();
                                that.parents("div.inputBox").hide();
                            } else {
                                alert("修改电话接口返回－1了");
                            }

                        })
                    }
                })
            },
            changeEmailFun: function() {
                $("#codeEmailBtn").on("click", function() { //获取短信验证吗send
                    var emailVal = $("#emailVal").val(),
                        reg = /^[A-Za-z\d]+([-_.][A-Za-z\d]+)*@([A-Za-z\d]+[-.])+[A-Za-z\d]{2,4}$/,
                        sendObj = {};
                    console.log(reg.test(emailVal))
                    if (reg.test(emailVal) && emailVal != "") {
                        sendObj.emal = emailVal;
                        sendObj.type = 1;
                        common.ajaxFun(funObj.InterfaceObj.send, "GET", sendObj, function(res) {
                            if (res.status == 1) {
                                funObj.setTimeoutFun(60, $("#codeEmailBtn"));
                                $("#goEmail").show();
                            } else {
                                alert("邮箱接口返回－1了");
                            }
                        })
                    }
                });
            },
            setTimeoutFun: function(long, ele) { //long 时长，ele 对象
                var TimeLong = long,
                    Timer = setInterval(function() {

                        if (TimeLong > 0) {
                            TimeLong--;
                            ele.val(TimeLong + "秒重新获取");
                            ele.off("click");
                        } else {
                            clearInterval(Timer);
                            ele.val("获取验证码");
                            funObj.changeTelFun();
                        }
                    }, 1000);
                ele.val(TimeLong + "秒重新获取");

            }
        }
        funObj.inits();
    </script>
</body>

</html>